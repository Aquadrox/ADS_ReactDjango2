name: CI & Déploiement Backend Django

# Se déclenche sur push ou PR vers master
on:
  push:
    branches: [ master ]
  pull_request:
    branches: [ master ]

jobs:
  # ======================================================
  # JOB 1: TESTS (s'exécute dans le Cloud GitHub)
  # ======================================================
  test:
    name: Tests, Linting & Sécurité
    runs-on: ubuntu-latest # <- Le test tourne dans le cloud

    defaults:
      run:
        working-directory: ./my_app/backend_project

    steps:
    - name: 1. Récupère le code
      uses: actions/checkout@v4

    - name: 2. Installe Python et cache Poetry
      uses: actions/setup-python@v5
      with:
        python-version: '3.13'
        cache: 'poetry'
        cache-dependency-path: 'my_app/backend_project/poetry.lock'

    - name: 3. Installe les outils et dépendances
      run: |
        pip install poetry
        poetry config virtualenvs.in-project true
        poetry install --no-root # --no-root est plus propre pour le CI

    - name: 4. Lancement Flake8 (Linting)
      run: |
        poetry run flake8 src/ --count --show-source --statistics

    - name: 5. Lancement Bandit (Sécurité)
      run: |
        poetry run bandit -r src/

    - name: 6. Lancement des Tests Unitaires
      run: |
        poetry run python src/manage.py test api

  # ======================================================
  # JOB 2: DÉPLOIEMENT (s'exécute sur VOTRE VM)
  # ======================================================
  deploy:
    name: Déployer en Production

    # 1. Ne s'exécute que si les tests ont réussi
    needs: test

    # 2. Ne s'exécute que sur PUSH vers 'master' (pas les PR)
    if: github.event_name == 'push' && github.ref == 'refs/heads/master'

    # 3. Cible l'environnement "production"
    # C'est ce qui déclenche l'approbation MANUELLE que vous avez configurée
    environment:
      name: production

    # 4. LE POINT MAGIQUE : s'exécute sur votre VM
    runs-on: self-hosted

    steps:
      # 5. L'UNIQUE ÉTAPE : Exécute le script localement
      - name: Lancement du script de mise à jour Blue/Green
        run: |
          echo "--- Lancement du script Update.sh (situé sur le runner) ---"
          /var/www/scripts/Update.sh