name: CI Backend Django

on:
  push:
    branches: [ master ]
  pull_request:
    branches: [ master ]

jobs:
  # --- Job 1: Linting (Flake8) ---
  lint:
    name: üé® Linting (Flake8)
    runs-on: ubuntu-latest

    # D√©finit le dossier de travail pour toutes les commandes 'run' de ce job
    defaults:
      run:
        working-directory: my_app/backend_project

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    # Utilise le cache int√©gr√© de setup-python pour Poetry
    - name: Set up Python 3.13 with cache
      uses: actions/setup-python@v5
      with:
        python-version: '3.13'
        cache: 'poetry'
        # Sp√©cifie o√π trouver le fichier de lock pour la cl√© de cache
        cache-dependency-path: 'my_app/backend_project/poetry.lock'

    - name: Install tools
      run: |
        # Pas besoin de 'cd' ici
        pip install poetry flake8 bandit
        poetry config virtualenvs.in-project true

    - name: Install dependencies
      run: poetry install --only main --sync

    - name: Run Flake8 (Linting)
      run: poetry run flake8 src/ --count --show-source --statistics

  # --- Job 2: S√©curit√© (Bandit) ---
  security:
    name: üõ°Ô∏è S√©curit√© (Bandit)
    runs-on: ubuntu-latest

    # D√©finit le dossier de travail pour toutes les commandes 'run' de ce job
    defaults:
      run:
        working-directory: my_app/backend_project

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    # Le cache sera r√©utilis√© ici si la cl√© (poetry.lock) n'a pas chang√©
    - name: Set up Python 3.13 with cache
      uses: actions/setup-python@v5
      with:
        python-version: '3.13'
        cache: 'poetry'
        cache-dependency-path: 'my_app/backend_project/poetry.lock'

    - name: Install tools
      run: |
        pip install poetry flake8 bandit
        poetry config virtualenvs.in-project true

    - name: Install dependencies
      run: poetry install --only main --sync

    - name: Run Bandit (Security)
      run: poetry run bandit -r src/

  # --- Job 3: Tests Unitaires (Pytest/Django) ---
  unit-test:
    name: üß™ Tests Unitaires
    runs-on: ubuntu-latest

    # D√©finit le dossier de travail pour toutes les commandes 'run' de ce job
    defaults:
      run:
        working-directory: my_app/backend_project

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python 3.13 with cache
      uses: actions/setup-python@v5
      with:
        python-version: '3.13'
        cache: 'poetry'
        cache-dependency-path: 'my_app/backend_project/poetry.lock'

    - name: Install tools
      run: |
        pip install poetry flake8 bandit
        poetry config virtualenvs.in-project true

    - name: Install dependencies
      # Note: On installe TOUTES les d√©pendances ici (y compris 'dev' si les tests en ont besoin)
      # Si vos tests n'ont pas besoin de 'dev', utilisez '--only main'
      run: poetry install --sync

    - name: Run Unit Tests
      run: poetry run python src/manage.py test api