# üöÄ 3. D√©ploiement (Apache + mod_wsgi)

# --- A. PR√âREQUIS SYST√àME ---
sudo apt update
sudo apt install apache2 libapache2-mod-wsgi-py3 python3-venv
# (Installer Poetry si absent)

# --- B. COPIE ET PERMISSIONS (LE C≈íUR) ---

# 1. Copier les fichiers (ex: depuis le dossier home)
sudo cp -r ~/my_app /var/www/

# 2. Cr√©er le groupe et y ajouter les utilisateurs
sudo groupadd webmasters
sudo usermod -aG webmasters vboxuser
sudo usermod -aG webmasters www-data

#
# !! ACTION REQUISE !!
# D√âCONNECTEZ-VOUS ET RECONNECTEZ-VOUS (ssh)
# pour que 'vboxuser' soit bien dans le groupe 'webmasters'.
#

# 3. D√©finir la propri√©t√© (Utilisateur:Groupe)
sudo chown -R vboxuser:webmasters /var/www/my_app

# 4. Appliquer les permissions de base (Dossiers=775, Fichiers=664)
sudo find /var/www/my_app -type d -exec chmod 775 {} \;
sudo find /var/www/my_app -type f -exec chmod 664 {} \;

# 5. FSorcer l'h√©ritage du groupe (setgid) sur TOUS les dossiers
# (Correction 2 : s'applique √† tous les dossiers, pas juste √† la racine)
sudo find /var/www/my_app -type d -exec chmod g+s {} \;

# --- C. INSTALLATION BACKEND ---
cd /var/www/my_app/backend_project

# 1. Configurer Poetry pour cr√©er le .venv dans le projet
poetry config virtualenvs.in-project true

# 2. Installer les d√©pendances
# (Correction 3 : syntaxe moderne)
poetry install --only main

# 3. Activer le shell pour les commandes Django
poetry shell

# 4. Aller dans le dossier 'src' de Django
cd src

# 5. Pr√©parer Django pour la prod
python manage.py collectstatic --noinput
python manage.py migrate

# 6. Quitter le vEnv
exit

# --- D. INSTALLATION FRONTEND ---
cd /var/www/my_app/frontend_app

# 1. Installer les d√©pendances
npm install

# 2. Cr√©er les fichiers statiques de production
npm run build

# --- E. CONFIGURATION ET D√âMARRAGE APACHE ---

# 1. Cr√©er le fichier de configuration
sudo nano /etc/apache2/sites-available/my_app.conf
# (Coller le contenu du fichier .conf ici)

# 2. Activer le site et d√©sactiver celui par d√©faut
sudo a2dissite 000-default.conf
sudo a2ensite my_app.conf

# 3. Tester la syntaxe
sudo apache2ctl configtest
# (Doit afficher "Syntax OK")

# 4. Red√©marrer Apache pour tout appliquer
sudo systemctl restart apache2

# --- F. D√âBOGAGE ---
# (En cas d'erreur 500, pour voir les erreurs Python)
# sudo tail -f /var/log/apache2/my_app-error.log